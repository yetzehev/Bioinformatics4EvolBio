---
title: "Metadata maices"
author: "Idalia Rojas"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(kableExtra)
library(tidyr)
library(dplyr)
library(tidyverse)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```

# Tablas de metadatos y construcción de subconjunto de datos

Dependencias en bash: - vcftools - plink - tabix

Librerias en R: - kniitr - kableExtra - tidyr - dplyr - tidyverse

Si los directorios **`meta`** **`subset`** no existen en tu directorio
de trabajo, crealos con el siguiente comando:

```{r mkdir}
#system('mkdir ./meta')
#system('mkdir ./subset')
```

### Cargar archivos en Rstudio

En este caso, emplearemos **datos** públicos de un estudio publicado en
2019, que empleó datos genómicos de **razas** de **maíz** para evaluar
la evolución de este cultivo en México, donde se encuentra el centro de
origen y diversidad para este cultivo.

El artículo [*Contemporary evolution of maize landraces and their wild
relatives influenced by gene flow with modern maize
varieties*](https://www.pnas.org/doi/full/10.1073/pnas.1817664116) puede
ser consultado en este
[enlace](https://www.pnas.org/doi/full/10.1073/pnas.1817664116), y los
datos genómicos y metadatos están disponibles en el repositorio de
[OSF](https://osf.io/pqvt4/).

```{r tablas}
genotipos <-read.delim("./meta/metadata_385_taxa_Rojas_etal_2019.txt", sep = ",")

accesiones <- read.delim( "./meta/Samples_and_Accessions.csv", sep = "\t", skip = 7)

kable(head(genotipos, 3), align = "c") %>%
  kable_styling(full_width = FALSE)

kable(head(accesiones, 3), align = "c") %>%
  kable_styling(full_width = FALSE)

```

### Editar las tablas de datos

Extracción de los IDs para armar un subconjunto de datos con los maíces,
excluyendo a los parientes silvestres. Es posible emplear los comandos
de Bash dentro de un script de R. Para ello debemos usar el comando
**`system`** y escribir el comando de Bash entre comillas.

```{r lista_IDs}
#Usar un comando de bash en R
system("bcftools query -l ../../data/Zea_mays.AGPv4.2x_0.8_0.01.NewID.Rojas2019.recode.vcf > ./meta/genotypes_vcf.txt")

#Cargar el set de datos extraído del archivo VCF y asignar nombres a las columnas
IDs<- read.delim("./meta/genotypes_vcf.txt", sep = "_", header = FALSE)
kable(head(IDs, 5), align = "c") %>% 
  kable_styling(full_width = FALSE)
```

Esta es la manera en que lucen los IDs de los genotipos extraidos de un
archivo VCF. En este caso la columna 1 repesenta el ID-unico del
genotipo y la columna 2 el nombre de la accesion a la que esta asignado
ese genotipo.

Ahora asignaremos nombres a las columnas de los IDs extraidos:
**`Genotipo`** y **`Accesion_ID`**

```{r VCF}
colnames(IDs) <- c("Genotipo", "Accesion_ID")

#Extraer la información contenida en la columna de Accesion_ID
extract <- IDs %>% separate(Accesion_ID,
                       into = c("Raza", "Cultivar", "Anio_colecta"),
                       sep = c(2,4,8))
#Merge our new information 
IDs<- merge(IDs, extract, by = "Genotipo")
kable(head(IDs, 5), align = "c") %>% 
  kable_styling(full_width = FALSE)

```

Una vez extraída la información hagamos un subconjunto unicamente con
los genotipos de maíces. La abreviatura **`Tm y Tp`** en la columna
**`Cultivar`** hace referencia a teosintes.

```{r subsets}
Teosintes <- IDs[IDs$Cultivar %in% c("Tp", "Tm"),]

#Verifica cuantas razas de maiz tenemos en el set de datos
razas_simpatricas <- levels(factor(Teosintes$Raza))
nrazas <- nlevels(factor(Teosintes$Raza))
print(paste("Nuestro conjunto de datos contiene los genotipos para", nrazas, "razas:", toString(razas_simpatricas)))
kable(head(Teosintes, 5), align = "c") %>% 
  kable_styling(full_width = FALSE)
```

Ahora vamos a sustituir los nombres abreviados de las razas por los
nombres en extenso empleando la siguiente clave:

```{r pressure, echo=FALSE}
#Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
# Your data
df <- data.frame(
  Abreviatura = c("Bo", "Ch", "Ms", "Pp", "Tb", "Va", "Zm", "Hn"),
  `Nombre en extenso` = c("Bonito", "Chalqueno", "Mushito", "Pepitilla", "Tabloncillo", "Vandeno", "Zamorano", "Hibrido")
)

# Print centered table
kable(df, align = "c") %>%
  kable_styling(full_width = FALSE)
```

Crea la columna **`Extenso`** y sustituye las abreviaturas con los
nombres dados en la tabla anterior.

```{r editarDF}
Teosintes$Extenso <- Teosintes$Cultivar

#Sustituir los valores
#Recode la columna Extenso
Teosintes$Extenso <- recode(Teosintes$Extenso, 
                                Tp = "Zea mays ssp. parviglumis", Tm = "Zea mays ssp. mexicana")


```

### Subconjunto de datos con un subset de genotipos

El subset de datos con maíces esta integrado por 386 genotipos, para
reducir el tiempo de computo y el tamaño de los archivos generaremos una
**lista con 136 genotipos**.

```{r subset_maices, echo= FALSE}

teosintes_subset <- read.delim("./meta/teosintes_subset.txt", header = FALSE, sep = "_")
colnames(teosintes_subset) <- c("Genotipo", "Accession_ID")
teosintes_slice <- Teosintes[Teosintes$Genotipo %in% teosintes_subset$Genotipo,]

#set.seed(123)  # For reproducibility
#maices_slice <- maices[sample(nrow(maices), 50), ]
kable(head(teosintes_slice,5), align = "c") %>%
  kable_styling(full_width = FALSE)

```

### Agregar metadatos: coordenadas y altitud
El archivo **accessiones** contiene la informacion de las coordenadas y altitud de cada accession. Usando como referencia la columna **`Accesio_ID`**, fusionaremos la tabla `maices_slice` y `accesiones`.

```{r add.coord}
teosintes_meta <- merge(teosintes_slice, accesiones, by = "Accesion_ID", all.x = TRUE)
kable(head(teosintes_meta,5), align = "c") %>% 
  kable_styling(full_width = FALSE)

write.table(teosintes_meta, "./meta/teosintes_subset_metadata.txt",
            sep = "\t", row.names = FALSE, quote = FALSE)
```

### Extracción de un un subconjunto de genotipos de los archivos VCF y plink

Ahora generaremos la lista de genotipos para hacer el subconjunto de
genotipos del archivo vcf y plink.

1.  El archivo para crear el subset del archivo ***VCF*** solo requiere
    ***una columna** con la lista de genotipos*.
2.  El archivo para hacer el subset del archivo ***plink** requiere
    **dos columnas**,* *una representa el genotipo y la otra la
    familia*.

```{R plink_subset}

subset_vcf<- paste(teosintes_slice$Genotipo, teosintes_slice$Accesion_ID, sep = "_")

subset_plink <- teosintes_slice %>% 
  transmute(
    ID = paste(Genotipo, Accesion_ID, sep = "_"),  # Creates a new column
    Family = paste(Genotipo, Accesion_ID, sep = "_")  # Optional: same as ID
  )

write.table(subset_vcf, "./meta/subset_teosintes_vcf.txt",quote = FALSE, row.names = FALSE, col.names = FALSE)
write.table(subset_plink, "./meta/subset_teosintes_plink.txt",quote = FALSE, row.names = FALSE, col.names = FALSE)
```

El siguiente paso es transformar los archivos VCF en archivos plink

La compresion del archivo requiere **`tabix`**

```{r}
system("vcftools --vcf ./../../data/Zea_mays.AGPv4.2x_0.8_0.01.NewID.Rojas2019.recode.vcf --keep ./meta/subset_teosintes_vcf.txt --recode --out ./subset/teosintes_subset")
#system("bgzip -c ./subset/teosintes_subset.recode.vcf > ./subset/teosintes_subset.vcf.gz")
```

Filtra los SNPs empleando plink

```{r transformacion}
#Filtrado de SNPs
system("~/bin/plink/plink --vcf ./subset/teosintes_subset.recode.vcf  --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out ./subset/teosintes_subset")
```

Realizar el PCA

```{R PCA}
# prune and create pca
system("~/bin/plink/plink  --vcf  ./subset/teosintes_subset.recode.vcf --double-id --allow-extra-chr --set-missing-var-ids @:# --extract ./subset/teosintes_subset.prune.in --make-bed --pca --out ./subset/teosintes_subset")
```

Cargar el resultado del PCA

```{r graficar}
# read in data
pca <- read.delim("./subset/teosintes_subset.eigenvec", sep = " ", header = FALSE)
eigenval <- scan("./subset/teosintes_subset.eigenval")
```

Asignar los nombres a los genotipo

```{r IND_PCA}

# sort out the pca data
# remover la columna extra con los IDs
pca <- pca[,-1]
# set names
names(pca)[1] <- "ind"
names(pca)[2:ncol(pca)] <- paste0("PC", 1:(ncol(pca)-1))
```

Agregar los nombres en extenso de las razas

```{r IDs_razas}
# sort out the individual species and pops
# spp
subespecies <- rep(NA, length(pca$ind))
subespecies[grep("Tm", pca$ind)] <- "Z.m. ssp. mexicana"
subespecies[grep("Tp", pca$ind)] <- "Z.m. ssp. parviglumis"

pca <- data.frame(pca, subespecies)


```

Graficar los eigenvectores

```{r eigenv}
# first convert to percentage variance explained
pve <- data.frame(PC = 1:20, pve = eigenval/sum(eigenval)*100)
```

Grafica la propocion de variacion que explica cada eigenvector

```{r eigenv_plot}
# make plot
a <- ggplot(pve, aes(PC, pve)) + geom_bar(stat = "identity")
a + ylab("Percentage variance explained") + theme_light()
```

```{r eigenv_cumm}
# calculate the cumulative sum of the percentage variance explained
cumsum(pve$pve)
```

Plot PCA

```{r }

# plot pca
b <- ggplot(pca, aes(PC1, PC2, col = subespecies)) + geom_point(size = 3)

b <- b + coord_equal() + theme_light()
b + xlab(paste0("PC1 (", signif(pve$pve[1], 3), "%)")) + ylab(paste0("PC2 (", signif(pve$pve[2], 3), "%)"))

```
