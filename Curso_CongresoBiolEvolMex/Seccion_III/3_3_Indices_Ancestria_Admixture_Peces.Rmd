---
title: "3_3_Ancestria_Admixture_Plectopromus"
author: "Idalia Rojas"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#### Call libraries
```{r set_environment}
library(wesanderson)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
getwd()
#system("mkdir ./out")

```
#### 1. Requerimentos

-   vcftools 
-   bcftools
-   ADMIXTURE

#### 2. Generar achivos de entrada
Admixture emplea archivos binarios de plink para estimar el numero de grupos geneticos. Emplearemos **`plink`**
**NOTE:** Vías absolutas actualizadas para ejecutar el código en el servidor del IB.

```{r input.file}
system( "plink --vcf ../../../course_data/subset/radiator_data_20220330_1452_neutral.vcf --make-bed --allow-extra-chr --out ./subset/plectopromus ")

# ADMIXTURE does not accept chromosome names that are not human chromosomes. We will thus just exchange the first column by 0
system("awk '{$1=\"0\";print $0}' ./subset/plectopromus.bim > ./subset/plectopromus.bim.tmp")
system("mv ./subset/plectopromus.bim.tmp ./subset/plectopromus.bim")

```

#### 3. Ejecutar ADMIXTURE
Con los archivos binarios de **`plink`** ejecutaremos ADMIXTURE con un valor de K desde 1 hasta 7. Recuerda que ADMIXTURE funciona como un `stand alone` package en bash, pero emplearemos el comando system para ejecutarlo sn salir de Rstudio. 
```{r ADMIXTURE}
system("bash -c 'for K in {1..7}; do admixture -s time --cv=10 -j4 ./subset/plectopromus.bed $K | tee ./results/plectopromus_${K}.out; done'")

```
Extraer y graficar los valores de CV
```{r plot.CV}
system("grep 'CV' ./results/plectopromus*.out | sed -E 's/.*K=([0-9]+).*: ([0-9.]+).*/\\1\\t\\2/' > ./results/plectopromus_clean.CV")
CVE <- read.delim("./results/plectopromus_clean.CV", sep = "\t", header = F)
colnames(CVE) <- c("K", "CVE")
plot(CVE)

```

#### 4. Graficar indices de ancestría
El siguiente paso es graficar el numero de cluster con el Error de Validacion Cruzada (CVE) mas bajo, que en este caso es K=4.

```{r pressure, echo=TRUE}
IDs <- read.delim("./subset/plectopromus.fam", header = FALSE, sep = ' ')
colnames(IDs) <- c("Individuo", "Accesion")




# Read the data
K2 <- read.delim("./plectopromus.2.Q", header = FALSE, sep = " ")
rownames(K2) <- IDs$Individuo

# Sort K4 by the values in the first column
K2 <- K2[order( K2[,1],  K2[,2]), ]

# Transpose for barplot
K2_t <- t(K2)

# Set color palette from Wes Anderson
colors <- wes_palette("Zissou1", n = nrow(K2_t), type = "continuous")

#png("./out/ancestry_matrix.png", width = 1200, height = 800, res = 150)
# Plot barplot
barplot(K2_t,
        col = colors,
        border = NA,
        space = 0,
        ylab = "Ancestry proportions",
        main = "Ancestry matrix", 
         xaxt = "n") -> bp

# Add x-axis labels rotated vertically
axis(1,
     at = bp,
     labels = rownames(K2),
     las = 2,            # Vertical text
     cex.axis = 0.4)     # Smaller text to avoid overlap
#dev.off()

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
