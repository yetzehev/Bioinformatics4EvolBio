---
title: "Clutering Plectropomus"
author: "Idalia Rojas"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(kableExtra)
library(tidyr)
library(dplyr)
library(tidyverse)
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
```
Crear directorio `meta`

```{r mkdir}
#system('mkdir ./meta')

```
### Editar las tablas de datos

Extracción de los IDs del archivo VCF. Es posible emplear los comandos
de Bash dentro de un script de R. Para ello debemos usar el comando
**`system`** y escribir el comando de Bash entre comillas.

```{r lista_IDs}
#Usar un comando de bash en R
system("bcftools query -l ./data/dryad/radiator_data_20220330_1452_neutral.vcf > ./meta/genotypes_vcf.txt")

#Cargar el set de datos extraído del archivo VCF y asignar nombres a las columnas
IDs<- read.delim("./meta/genotypes_vcf.txt", sep = "_", header = FALSE)
kable(head(IDs, 5), align = "c") %>% 
  kable_styling(full_width = FALSE)
```
Filtrado de los SNPs empleando plink

```{r transformacion}
#Filtrado de SNPs
system("~/bin/plink/plink --vcf ./data/dryad/radiator_data_20220330_1452_neutral.vcf --double-id --allow-extra-chr --set-missing-var-ids @:# --indep-pairwise 50 10 0.1 --out ./data/radiator_data_20220330_1452_neutral")
```

Realizar el PCA con `plink`

```{R PCA}
# prune and create pca
system("~/bin/plink/plink  --vcf  ./data/dryad/radiator_data_20220330_1452_neutral.vcf --double-id --allow-extra-chr --set-missing-var-ids @:# --extract ./data/radiator_data_20220330_1452_neutral.prune.in --make-bed --pca --out ./data/radiator_data_20220330_1452_neutral")
```

Cargar el resultado del PCA

```{r graficar}
# read in data
pca <- read.delim("./data/radiator_data_20220330_1452_neutral.eigenvec", sep = " ", header = FALSE)
eigenval <- scan("./data/radiator_data_20220330_1452_neutral.eigenval")
```
Remover la columna extra con los IDs

```{r IND_PCA}

# sort out the pca data
# remover la columna extra con los IDs
pca <- pca[,-1]
# set names
names(pca)[1] <- "ind"
names(pca)[2:ncol(pca)] <- paste0("PC", 1:(ncol(pca)-1))
```

Graficar los eigenvectores

```{r eigenv}
# first convert to percentage variance explained
pve <- data.frame(PC = 1:20, pve = eigenval/sum(eigenval)*100)
```

Grafica la propocion de variacion que explica cada eigenvector

```{r eigenv_plot}
# make plot
a <- ggplot(pve, aes(PC, pve)) + geom_bar(stat = "identity")
a + ylab("Percentage variance explained") + theme_light()
```

```{r eigenv_cumm}
# calculate the cumulative sum of the percentage variance explained
cumsum(pve$pve)
```

Graficar el PCA

```{r }

# plot pca
b <- ggplot(pca, aes(PC1, PC2 )) + geom_point(size = 3)

b <- b + coord_equal() + theme_light()
b + xlab(paste0("PC1 (", signif(pve$pve[1], 3), "%)")) + ylab(paste0("PC2 (", signif(pve$pve[2], 3), "%)"))

```
